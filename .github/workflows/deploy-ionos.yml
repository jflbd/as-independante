name: Deploy to IONOS with notification

on:
  push:
    branches:
      - deploy

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Inject .env from GitHub Variables
        run: |
          touch .env
          echo "EMAIL_PORT=${{ vars.EMAIL_PORT }}" >> .env
          echo "EMAIL_RECIPIENT=${{ vars.EMAIL_RECIPIENT }}" >> .env
          echo "EMAIL_SECURE=${{ vars.EMAIL_SECURE }}" >> .env
          echo "EMAIL_SERVICE=${{ vars.EMAIL_SERVICE }}" >> .env
          echo "MAILCHIMP_API_KEY=${{ vars.MAILCHIMP_API_KEY }}" >> .env
          echo "MAILCHIMP_AUDIENCE_ID=${{ vars.MAILCHIMP_AUDIENCE_ID }}" >> .env
          echo "MAILCHIMP_LIST_ID=${{ vars.MAILCHIMP_LIST_ID }}" >> .env
          echo "MAILCHIMP_SERVER_ID=${{ vars.MAILCHIMP_SERVER_ID }}" >> .env
          echo "MAILCHIMP_SERVER_PREFIX=${{ vars.MAILCHIMP_SERVER_PREFIX }}" >> .env
          echo "NODE_ENV=${{ vars.NODE_ENV }}" >> .env
          echo "SITE_URL=${{ vars.SITE_URL }}" >> .env
          echo "VITE_API_BASE_URL=${{ vars.VITE_API_BASE_URL }}" >> .env
          echo "VITE_DEBUG=${{ vars.VITE_DEBUG }}" >> .env
          echo "VITE_PAYPAL_CLIENT_ID=${{ vars.VITE_PAYPAL_CLIENT_ID }}" >> .env
          echo "VITE_STRIPE_PUBLISHABLE_KEY=${{ vars.VITE_STRIPE_PUBLISHABLE_KEY }}" >> .env
          # Ajoute d'autres variables ici si nécessaire

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Deploy to IONOS via FTP (clean first)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: dist/
          server-dir: /htdocs/
          dangerous-clean-slate: true

      - name: Notify Rachel by email via IONOS SMTP
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_HOST }}
          server_port: ${{ vars.EMAIL_PORT }}
          secure: ${{ vars.EMAIL_SECURE }}
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "🚀 Nouveau déploiement du site as-independante.fr"
          to: ${{ secrets.RACHEL_EMAIL }}
          from: ${{ secrets.EMAIL_HOST }}
          body: |
            Bonjour Rachel,

            Le site vient d'être mis à jour 🎉

            🔗 https://www.as-independante.fr/

            — JFL 👨‍💻